define(["jquery","core/log","core/autoscroll"],function(a,b,c){var d,e,f,g={listSelector:null,isHorizontal:!1,moveHandlerSelector:null,isDraggedClass:"sortable-list-is-dragged",currentPositionClass:"sortable-list-current-position",sourceListClass:"sortable-list-source",targetListClass:"sortable-list-target",overElementClass:"sortable-list-over-element",onDrop:null,onDragStart:null,onMove:null,onDragCancel:null},h={},i={},j=function(){var b=a(h.listSelector);b.children().removeClass(h.isDraggedClass).removeClass(h.currentPositionClass).removeClass(h.overElementClass),b.removeClass(h.targetListClass).removeClass(h.sourceListClass)},k=function(b){if(b.originalEvent&&void 0!==b.originalEvent.touches[0]){var c=b.originalEvent.touches[0];b.pageX=c.pageX,b.pageY=c.pageY}void 0===b.pageX?(b.pageX=f.pageX,b.pageY=f.pageY):f=b,void 0===b.clientX&&(b.clientX=Math.round(b.pageX-a(window).scrollLeft()),b.clientY=Math.round(b.pageY-a(window).scrollTop()))},l=function(b){h=b.data.params,j(),k(b);var f=a(b.currentTarget);if(null===h.moveHandlerSelector||a(b.target).closest(h.moveHandlerSelector,f).length){b.stopPropagation(),b.preventDefault(),i={draggedElement:f,sourceNextElement:f.next(),sourceList:f.parent(),targetNextElement:f.next(),targetList:f.parent(),dropped:!1,startX:b.pageX,startY:b.pageY,startTime:(new Date).getTime()},a(h.listSelector).addClass(h.targetListClass);var g=f.offset();d=f.clone(),f.parent().append(d),d.removeAttr("id").addClass(h.isDraggedClass).css({position:"fixed"}),f.addClass(h.currentPositionClass),d.offset(g),e={x:g.left-b.pageX,y:g.top-b.pageY},a("body").on("mousemove touchmove mouseup touchend",o),a("body").on("keypress",s),c.start(function(){a("body").trigger("mousemove")})}},m=function(a,b,c){if(!c.length)return null;var d=c[0],e=0,f=d.getBoundingClientRect(),g=b-(f.top+window.scrollY),h=a-(f.left+window.scrollX);return h>=-e&&h<=f.width+e&&g>=-e&&g<=f.height+e?{x:h,y:g,xRatio:f.width?h/f.width:0,yRatio:f.height?g/f.height:0}:null},n=function(){return this!==d[0]},o=function(b){k(b),d.offset({top:-1e3,left:-1e3});var c=a(document.elementFromPoint(b.clientX,b.clientY)),f=c.closest(h.listSelector+" > :not(."+h.isDraggedClass+")"),g=c.closest(h.listSelector);if(a("."+h.overElementClass).removeClass(h.overElementClass),f.addClass(h.overElementClass),d.offset({top:e.y+b.pageY,left:e.x+b.pageX}),g.length&&!g.children().filter(n).length)p(g,a());else if(1===f.length){var j=m(b.pageX,b.pageY,f);if(j){var l=f.parent(),o=h.isHorizontal?j.xRatio:j.yRatio;o>.5?p(l,f.next().filter(n)):p(l,f)}}"mouseup"!==b.type&&"touchend"!==b.type||(i.endX=b.pageX,i.endY=b.pageY,i.endTime=(new Date).getTime(),i.dropped=!0,r("onDrop"),q())},p=function(a,b){var c=i.draggedElement;b.length&&b[0]===c[0]||a[0]===i.targetList[0]&&b.length===i.targetNextElement.length&&b[0]===i.targetNextElement[0]||(b.length?a[0].insertBefore(c[0],b[0]):d.parent().length&&d.parent()[0]===a[0]?a[0].insertBefore(c[0],d[0]):a[0].appendChild(c[0]),i.targetList=a,i.targetNextElement=b,r("onMove"))},q=function(){j(),c.stop(),a("body").off("mousemove touchmove mouseup touchend",o),a("body").off("keypress",s),d.remove(),d=null},r=function(a){var b=h[a];null!==b&&b(i)},s=function(a){"keypress"===a.type&&27===a.originalEvent.keycode&&(p(i.sourceList,i.sourceNextElement),r("onDragCancel"),q())};return{init:function(c){return"undefined"==typeof c.listSelector?void b.error("Parameter listSelector must be specified"):(c=a.extend({},g,c),void a(c.listSelector).on("mousedown touchstart","> *",{params:c},l))}}});