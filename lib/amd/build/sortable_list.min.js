define(["jquery","core/log"],function(a,b){var c={listSelector:null,moveHandlerSelector:null,isDraggedClass:"sortable-list-is-dragged",currentPositionClass:"sortable-list-current-position",sourceListClass:"sortable-list-source",targetListClass:"sortable-list-target",onDrop:null,onDragStart:null,onMove:null,onDragCancel:null},d=function(b){var c=a(b.listSelector);c.children().removeClass(b.isDraggedClass).removeClass(b.currentPositionClass),c.removeClass(b.targetListClass).removeClass(b.sourceListClass)},e=null,f=function(a){e=a.target},g=function(b){var c=b.data.params;d(c);var f=a(b.target),g=c.moveHandlerSelector;(null===g||a(e).closest(g,f).length)&&(b.data.info={draggedElement:f,sourceNextElement:f.next(),sourceList:f.parent(),targetNextElement:f.next(),targetList:f.parent(),dropped:!1},b.originalEvent.dataTransfer.effectAllowed="move",b.originalEvent.dataTransfer.setData("text/plain","sortable-list"),a("body").on("dragover dragleave dragenter",b.data,j),a("body").on("drop dragdrop",b.data,l),a("body").on("dragend",b.data,n),a(c.listSelector).addClass(c.targetListClass),f.addClass(c.isDraggedClass),setTimeout(function(){f.removeClass(c.isDraggedClass).addClass(c.currentPositionClass),m("onDragCancel",b)},0))},h=function(b){var c=a(b.target),d=b.data.params.listSelector;if(a.contains(b.data.info.draggedElement[0],b.target))return a();if(!c.closest(d).length||c.is(d))return a();for(;c.length;){var e=c.parent();if(e.is(b.data.params.listSelector))return c;c=e}return a()},i=function(b){var c=a(b.target).closest(b.data.params.listSelector);if(c.length){var d=h(b);if(d.length){var e=d[0].getBoundingClientRect(),f=(b.pageY-d.offset().top)/(e.bottom-e.top)>.5;f?k(b,c,d.next()):k(b,c,d)}else c.children().length||k(b,c,a())}},j=function(a){a.preventDefault(),a.originalEvent.dataTransfer.dropEffect="move","dragleave"!==a.type&&setTimeout(function(){i(a)},0)},k=function(a,b,c){var d=a.data.info,e=d.draggedElement,f=b[0]===d.targetList[0]&&c.length===d.targetNextElement.length&&c[0]===d.targetNextElement[0];f||(c.length?b[0].insertBefore(e[0],c[0]):b[0].appendChild(e[0]),d.targetList=b,d.targetNextElement=c,m("onMove",a))},l=function(a){a.preventDefault(),a.data.info.dropped=!0,i(a),m("onDrop",a)},m=function(a,b){var c=b.data.params[a];null!==c&&c(b.data.info)},n=function(b){b.preventDefault();var c=b.data.info;c.dropped||(k(b,c.sourceList,c.sourceNextElement),m("onDragCancel",b)),a("body").off("dragover dragleave dragenter",j),a("body").off("drop dragdrop",l),a("body").off("dragend",n),d(b.data.params)};return{init:function(d){return"undefined"==typeof d.listSelector?void b.error("Parameter listSelector must be specified"):(d=a.extend({},c,d),a(d.listSelector).on("dragstart",{params:d},g),void(null!==d.moveHandlerSelector&&a(d.listSelector).on("mousedown",f)))}}});