define(["jquery","core/log","core/autoscroll"],function(a,b,c){var d,e,f,g={listSelector:null,isHorizontal:!1,moveHandlerSelector:null,isDraggedClass:"sortable-list-is-dragged",currentPositionClass:"sortable-list-current-position",sourceListClass:"sortable-list-source",targetListClass:"sortable-list-target",overElementClass:"sortable-list-over-element"},h={},i={},j=function(){var b=a(h.listSelector);b.children().removeClass(h.isDraggedClass).removeClass(h.currentPositionClass).removeClass(h.overElementClass),b.removeClass(h.targetListClass).removeClass(h.sourceListClass)},k=function(b){if(b.originalEvent&&b.originalEvent.touches&&void 0!==b.originalEvent.touches[0]){var c=b.originalEvent.touches[0];b.pageX=c.pageX,b.pageY=c.pageY}void 0===b.pageX?(b.pageX=f.pageX,b.pageY=f.pageY):f=b,void 0===b.clientX&&(b.clientX=Math.round(b.pageX-a(window).scrollLeft()),b.clientY=Math.round(b.pageY-a(window).scrollTop()))},l=function(b){h=b.data.params,j(),k(b);var f=a(b.currentTarget);if(null===h.moveHandlerSelector||a(b.target).closest(h.moveHandlerSelector,f).length){b.stopPropagation(),b.preventDefault(),i={draggedElement:f,sourceNextElement:f.next(),sourceList:f.parent(),targetNextElement:f.next(),targetList:f.parent(),dropped:!1,startX:b.pageX,startY:b.pageY,startTime:(new Date).getTime()},a(h.listSelector).addClass(h.targetListClass);var g=f.offset();f.addClass(h.currentPositionClass),e={x:g.left-b.pageX,y:g.top-b.pageY},d=a(),setTimeout(function(){m()},500),a("body").on("mousemove touchmove mouseup touchend",q),a("body").on("keypress",u),c.start(function(){a("body").trigger("mousemove")}),t("dragstart")}},m=function(){if(null!==i){var a=i.draggedElement;d=a.clone(),a.parent().append(d),d.removeAttr("id").removeClass(h.currentPositionClass).addClass(h.isDraggedClass).css({position:"fixed"}),d.offset({top:e.y+f.pageY,left:e.x+f.pageX})}},n=function(a){a.preventDefault(),console.log("click"),console.log(a),j(),i=null},o=function(a,b,c){if(!c.length)return null;var d=c[0],e=0,f=d.getBoundingClientRect(),g=b-(f.top+window.scrollY),h=a-(f.left+window.scrollX);return h>=-e&&h<=f.width+e&&g>=-e&&g<=f.height+e?{x:h,y:g,xRatio:f.width?h/f.width:0,yRatio:f.height?g/f.height:0}:null},p=function(){return!d.length||this!==d[0]},q=function(b){k(b),d.offset({top:-1e3,left:-1e3});var c=a(document.elementFromPoint(b.clientX,b.clientY)),f=c.closest("."+h.targetListClass+" > :not(."+h.isDraggedClass+")"),g=c.closest("."+h.targetListClass);if(a("."+h.overElementClass).removeClass(h.overElementClass),f.addClass(h.overElementClass),d.offset({top:e.y+b.pageY,left:e.x+b.pageX}),g.length&&!g.children().filter(p).length)r(g,a());else if(1===f.length){var j=o(b.pageX,b.pageY,f);if(j){var l=f.parent(),m=h.isHorizontal?j.xRatio:j.yRatio;m>.5?r(l,f.next().filter(p)):r(l,f)}}"mouseup"!==b.type&&"touchend"!==b.type||(i.endX=b.pageX,i.endY=b.pageY,i.endTime=(new Date).getTime(),i.dropped=!0,t("drop"),s())},r=function(a,b){var c=i.draggedElement;b.length&&b[0]===c[0]||a[0]===i.targetList[0]&&b.length===i.targetNextElement.length&&b[0]===i.targetNextElement[0]||(b.length?a[0].insertBefore(c[0],b[0]):d.parent().length&&d.parent()[0]===a[0]?a[0].insertBefore(c[0],d[0]):a[0].appendChild(c[0]),i.targetList=a,i.targetNextElement=b,t("drag"))},s=function(){j(),c.stop(),a("body").off("mousemove touchmove mouseup touchend",q),a("body").off("keypress",u),d.remove(),d=null,t("dragend"),i=null},t=function(a){i.draggedElement.trigger("sortablelist-"+a,i)},u=function(a){"keypress"===a.type&&27===a.originalEvent.keyCode&&(r(i.sourceList,i.sourceNextElement),s())};return{init:function(c){return"undefined"==typeof c.listSelector?void b.error("Parameter listSelector must be specified"):(c=a.extend({},g,c),a(c.listSelector).on("mousedown touchstart","> *",{params:c},l),void(null!==c.moveHandlerSelector&&(console.log("registering click handler for "+c.moveHandlerSelector),a(c.listSelector).on("click",c.moveHandlerSelector,{params:c},n))))}}});