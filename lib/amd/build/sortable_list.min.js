define(["jquery","core/log","core/drag"],function(a,b,c){var d={listSelector:null,moveHandlerSelector:null,isDraggedClass:"sortable-list-is-dragged",currentPositionClass:"sortable-list-current-position",sourceListClass:"sortable-list-source",targetListClass:"sortable-list-target",onDrop:null,onDragStart:null,onMove:null,onDragCancel:null},e={},f={},g=function(){var b=a(e.listSelector);b.children().removeClass(e.isDraggedClass).removeClass(e.currentPositionClass),b.removeClass(e.targetListClass).removeClass(e.sourceListClass)},h=function(b){e=b.data.params,g();var d=c.prepare(b);if(d.start){var h=a(b.currentTarget),i=e.moveHandlerSelector;if(null===i||a(b.target).closest(i,h).length){f={draggedElement:h,sourceNextElement:h.next(),sourceList:h.parent(),targetNextElement:h.next(),targetList:h.parent(),dropped:!1,startX:d.x,startY:d.y,startTime:(new Date).getTime()},a(e.listSelector).addClass(e.targetListClass);var k=h.offset(),m=h.clone();h.parent().append(m),m.removeAttr("id").addClass(e.isDraggedClass).css({position:"absolute"}),h.addClass(e.currentPositionClass),m.offset(k),c.start(b,m,j,l,n)}}},i=function(a,b,c,d){"undefined"==typeof d&&(d=0);var e=c.getBoundingClientRect(),f=b-(e.top+window.scrollY),g=a-(e.left+window.scrollX);return g>=-d&&g<=e.width+d&&f>=-d&&f<=e.height+d?{x:g,y:f,xRatio:g/Math.max(e.width,1),yRatio:f/Math.max(e.height,1)}:null},j=function(b,c,d){var g=!1,h=function(){return this!==d[0]};null===i(b,c,f.draggedElement[0])&&(a(e.listSelector).children().filter(h).each(function(){var e=i(b,c,this);if(null!==e)return this===f.draggedElement||(e.yRatio>.5?k(a(this).parent(),a(this).next().filter(h),d):k(a(this).parent(),a(this),d)),g=!0,!1}),g||a(e.listSelector).each(function(){if(!a(this).children().filter(h).length){var e=i(b,c,this,5);null!==e&&k(a(this),a(),d)}}))},k=function(a,b,c){var d=f.draggedElement;b.length&&b[0]===d[0]||a[0]===f.targetList[0]&&b.length===f.targetNextElement.length&&b[0]===f.targetNextElement[0]||(b.length?a[0].insertBefore(d[0],b[0]):c.parent().length&&c.parent()[0]===a[0]?a[0].insertBefore(d[0],c[0]):a[0].appendChild(d[0]),f.targetList=a,f.targetNextElement=b,m("onMove"))},l=function(a,b,c){j(a,b,c),f.endX=a,f.endY=b,f.endTime=(new Date).getTime(),m("onDrop"),g()},m=function(a){var b=e[a];null!==b&&b(f)},n=function(a,b,c){k(f.sourceList,f.sourceNextElement,c),m("onDragCancel"),g()};return{init:function(c){return"undefined"==typeof c.listSelector?void b.error("Parameter listSelector must be specified"):(c=a.extend({},d,c),void a(c.listSelector).on("mousedown touchstart","> *",{params:c},h))}}});