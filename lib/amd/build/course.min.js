define(["jquery","core/ajax","core/templates","core/notification","core/str","core/url","core/log","core/yui"],function(a,b,c,d,e,f,g,h){var i={EDITINPROGRESS:"editinprogress",SECTIONDRAGGABLE:"sectiondraggable",EDITINGMOVE:"editing_move"},j={ACTIVITYLI:"li.activity",ACTIONAREA:".actions",ACTIVITYACTION:"a.cm-edit-action[data-action]",MENU:".moodle-actionmenu[data-enhance=moodle-core-actionmenu]",TOGGLE:".toggle-display",SECTIONLI:"li.section",SECTIONACTIONMENU:".section_action_menu",HIGHLIGHT:"a.editing_highlight",SHOWHIDE:"a.editing_showhide"},k=function(a){var b;return h.use("moodle-course-util",function(c){b=c.Moodle.core_course.util.cm.getId(c.Node(a.get(0)))}),b},l=function(a){a.addClass(i.EDITINPROGRESS);var b=a.find(j.ACTIONAREA).get(0);if(b){var c=M.util.add_spinner(h,h.Node(b));return c.show(),c}return null},m=function(a){a.addClass(i.EDITINPROGRESS);var b=a.find(j.SECTIONACTIONMENU).get(0);if(b){var c=M.util.add_spinner(h,h.Node(b));return c.show(),c}return null},n=function(a,b,c){window.setTimeout(function(){a.removeClass(i.EDITINPROGRESS),b&&b.hide()},c)},o=function(a,b){if(h.use("moodle-course-coursebase",function(b){M.course.coursebase.invoke_function("setup_for_resource","#"+a)}),M.core.actionmenu&&M.core.actionmenu.newDOMNode&&M.core.actionmenu.newDOMNode(h.one("#"+a)),b){var c=j.MENU+" "+j.TOGGLE;h.one("#"+a+" "+c).simulate("click")}},p=function(c,e,f){var g=f.attr("data-keepopen"),h=f.attr("data-action"),i=l(c),k=b.call([{methodname:"core_course_edit_course_module",args:{id:e,action:h,sr:f.attr("data-sr")}}],!0);a.when.apply(a,k).done(function(b){c.replaceWith(b),a("<div>"+b+"</div>").find(j.ACTIVITYLI).each(function(){o(a(this).attr("id"),g)}),n(c,i,400),c.trigger({type:"coursemoduleedited",ajaxreturn:b,action:h})}).fail(function(b){n(c,i);var e=a.Event("coursemoduleeditfailed",{exception:b,action:h});c.trigger(e),e.isDefaultPrevented()||d.exception(b)})},q=function(a,b,c,d,h,i,k){var l=a.find(j.SECTIONACTIONMENU+" "+b);g.debug("replace_section_action_item "+b),g.debug(l),l.find("img").attr("src",f.imageUrl(c,"core")),e.get_string(d,h).done(function(a){g.debug("string "+a),l.find("span.menu-action-text").html(a),l.attr("title",a)}),i&&e.get_string(i,k).done(function(a){l.attr("title",a)})},r=function(c,e,f,g,i){var l=m(e),p=e.hasClass("hidden")?"show":"hide",r=[{methodname:"core_course_edit_section",args:{id:g,action:p}}];h.use("moodle-course-util",function(b){e.find(j.ACTIVITYLI).each(function(){r.push({methodname:"core_course_edit_course_module",args:{id:k(a(this)),action:"view",sr:i}})})});var s=b.call(r,!0);a.when.apply(a,s).done(function(){"hide"===p?(e.addClass("hidden"),q(e,j.SHOWHIDE,"i/show","showfromothers","format_"+c)):(e.removeClass("hidden"),q(e,j.SHOWHIDE,"i/hide","hidefromothers","format_"+c));for(var b=1;b<arguments.length;b++){var d=arguments[b];a("<div>"+d+"</div>").find(j.ACTIVITYLI).each(function(){var b=a(this).attr("id");a("#"+b).replaceWith(d),o(b,!1)})}n(e,l,400),e.trigger({type:"coursesectionedited",ajaxreturn:arguments,action:p})}).fail(function(b){n(e,l);var c=a.Event("coursesectioneditfailed",{exception:b,action:p});e.trigger(c),c.isDefaultPrevented()||d.exception(b)})},s=function(c,e,f,g){var h=m(e),i=e.hasClass("current")?"removemarker":"setmarker",k=[{methodname:"core_course_edit_section",args:{id:g,action:i}}],l="setmarker"===i?a(j.SECTIONLI+".current"):null,o=b.call(k,!0);a.when.apply(a,o).done(function(a){parseInt(a)===parseInt(g)&&("setmarker"===i?(e.addClass("current"),q(e,j.HIGHLIGHT,"i/marked","highlightoff","core","markedthistopic","core"),l.removeClass("current"),q(l,j.HIGHLIGHT,"i/marker","highlight","core","markthistopic","core")):(e.removeClass("current"),q(e,j.HIGHLIGHT,"i/marker","highlight","core","markthistopic","core"))),n(e,h,400),e.trigger({type:"coursesectionedited",ajaxreturn:a,action:i,oldmarker:l})}).fail(function(b){n(e,h);var c=a.Event("coursesectioneditfailed",{exception:b,action:i});e.trigger(c),c.isDefaultPrevented()||d.exception(b)})};return h.use("moodle-course-coursebase",function(b){M.course.coursebase.register_module({set_visibility_resource_ui:function(b){var c=a(b.element.getDOMNode()),d=k(c);if(d){var e=c.find("."+i.EDITINGMOVE).attr("data-sr"),f=a("<span>").attr("data-action","view").attr("data-sr",e);p(c,d,f)}}})}),{init_course_page:function(b){a("body").on("click keypress",j.ACTIVITYLI+" "+j.ACTIVITYACTION,function(b){if("keypress"!==b.type||13===b.keyCode){var c=a(this),d=c.closest(j.ACTIVITYLI),e=c.attr("data-action"),f=k(d);switch(e){case"moveleft":case"moveright":case"delete":case"duplicate":case"hide":case"hideoncoursepage":case"show":case"groupsseparate":case"groupsvisible":case"groupsnone":break;default:return}f&&(b.stopImmediatePropagation(),b.preventDefault(),p(d,f,c))}}),a("body").on("click keypress",j.SECTIONLI+" "+j.SECTIONACTIONMENU+" "+j.SHOWHIDE,function(c){if("keypress"!==c.type||13===c.keyCode){var d=a(this),e=d.closest(j.SECTIONLI),f=d.closest(j.SECTIONACTIONMENU),g=f.attr("data-sectionid");g&&(c.stopImmediatePropagation(),c.preventDefault(),r(b,e,f,g,d.attr("data-sr")))}}),a("body").on("click keypress",j.SECTIONLI+" "+j.SECTIONACTIONMENU+" "+j.HIGHLIGHT,function(c){if("keypress"!==c.type||13===c.keyCode){var d=a(this),e=d.closest(j.SECTIONLI),f=d.closest(j.SECTIONACTIONMENU),g=f.attr("data-sectionid");g&&(c.stopImmediatePropagation(),c.preventDefault(),s(b,e,f,g))}})}}});