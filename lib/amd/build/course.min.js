define(["jquery","core/ajax","core/templates","core/notification","core/str","core/url","core/yui"],function(a,b,c,d,e,f,g){var h={EDITINPROGRESS:"editinprogress",SECTIONDRAGGABLE:"sectiondraggable",EDITINGMOVE:"editing_move"},i={ACTIVITYLI:"li.activity",ACTIONAREA:".actions",ACTIVITYACTION:"a.cm-edit-action[data-action]",MENU:".moodle-actionmenu[data-enhance=moodle-core-actionmenu]",TOGGLE:".toggle-display",SECTIONLI:"li.section",SECTIONACTIONMENU:".section_action_menu",HIGHLIGHT:"a.editing_highlight",SHOWHIDE:"a.editing_showhide"};g.use("moodle-course-coursebase",function(){var a=M.course.format.get_section_selector();a&&(i.SECTIONLI=a)});var j=function(a){var b;return g.use("moodle-course-util",function(c){b=c.Moodle.core_course.util.cm.getId(c.Node(a.get(0)))}),b},k=function(a){var b;return g.use("moodle-course-util",function(c){b=c.Moodle.core_course.util.cm.getName(c.Node(a.get(0)))}),b},l=function(a){a.addClass(h.EDITINPROGRESS);var b=a.find(i.ACTIONAREA).get(0);if(b){var c=M.util.add_spinner(g,g.Node(b));return c.show(),c}return null},m=function(a){a.addClass(h.EDITINPROGRESS);var b=a.find(i.SECTIONACTIONMENU).get(0);if(b){var c=M.util.add_spinner(g,g.Node(b));return c.show(),c}return null},n=function(a){var b=M.util.add_lightbox(g,g.Node(a.get(0)));return b.show(),b},o=function(a,b,c){window.setTimeout(function(){a.removeClass(h.EDITINPROGRESS),b&&b.hide()},c)},p=function(a,b){a&&window.setTimeout(function(){a.hide()},b)},q=function(a,b){if(g.use("moodle-course-coursebase",function(){M.course.coursebase.invoke_function("setup_for_resource","#"+a)}),M.core.actionmenu&&M.core.actionmenu.newDOMNode&&M.core.actionmenu.newDOMNode(g.one("#"+a)),b){var c=i.MENU+" "+i.TOGGLE;g.one("#"+a+" "+c).simulate("click")}},r=function(b,c){var d=a("#"+b),e="[data-action="+c+"]";"groupsseparate"!==c&&"groupsvisible"!==c&&"groupsnone"!==c||(e="[data-action=groupsseparate],[data-action=groupsvisible],[data-action=groupsnone]"),d.find(e).is(":visible")?d.find(e).focus():d.find(i.MENU+" "+i.TOGGLE).focus()},s=function(c,e,f){var g,h=f.attr("data-keepopen"),j=f.attr("data-action"),k=l(c),m=b.call([{methodname:"core_course_module_action",args:{id:e,action:j,sr:f.attr("data-sr")?f.attr("data-sr"):0}}],!0);"duplicate"===j&&(g=n(f.closest(i.SECTIONLI))),a.when.apply(a,m).done(function(b){c.replaceWith(b),a("<div>"+b+"</div>").find(i.ACTIVITYLI).each(function(b){q(a(this).attr("id"),h),0===b&&r(a(this).attr("id"),j)}),o(c,k,400),p(g,400),c.trigger({type:"coursemoduleedited",ajaxreturn:b,action:j})}).fail(function(b){o(c,k),p(g);var e=a.Event("coursemoduleeditfailed",{exception:b,action:j});c.trigger(e),e.isDefaultPrevented()||d.exception(b)})},t=function(a,b){var c=a.attr("class").match(/modtype_([^\s]*)/)[1],f=k(a);e.get_string("pluginname",c).done(function(a){var c={type:a,name:f};e.get_strings([{key:"confirm"},{key:null===f?"deletechecktype":"deletechecktypename",param:c},{key:"yes"},{key:"no"}]).done(function(a){d.confirm(a[0],a[1],a[2],a[3],b)})})},u=function(a,b,c,d,g,h,j){var k=a.find(i.SECTIONACTIONMENU+" "+b);k.find("img").attr("src",f.imageUrl(c,"core")),e.get_string(d,g).done(function(a){k.find("span.menu-action-text").html(a),k.attr("title",a)}),h&&e.get_string(h,j).done(function(a){k.attr("title",a)})},v=function(c,e,f,h){var k=m(e),l=n(e),r=e.hasClass("hidden")?"show":"hide",s=[{methodname:"core_course_edit_section",args:{id:f,action:r}}];g.use("moodle-course-util",function(){e.find(i.ACTIVITYLI).each(function(){s.push({methodname:"core_course_module_action",args:{id:j(a(this)),action:"view",sr:h?h:0}})})});var t=b.call(s,!0);a.when.apply(a,t).done(function(){"hide"===r?(e.addClass("hidden"),u(e,i.SHOWHIDE,"i/show","showfromothers","format_"+c)):(e.removeClass("hidden"),u(e,i.SHOWHIDE,"i/hide","hidefromothers","format_"+c));for(var b=function(b){a("<div>"+b+"</div>").find(i.ACTIVITYLI).each(function(){var c=a(this).attr("id");a("#"+c).replaceWith(b),q(c,!1)})},d=1;d<arguments.length;d++)b(arguments[d]);o(e,k,400),p(l,400),e.trigger({type:"coursesectionedited",ajaxreturn:arguments,action:r})}).fail(function(b){o(e,k),p(l);var c=a.Event("coursesectioneditfailed",{exception:b,action:r});e.trigger(c),c.isDefaultPrevented()||d.exception(b)})},w=function(c,e,f){var g=m(e),h=n(e),j=e.hasClass("current")?"removemarker":"setmarker",k=[{methodname:"core_course_edit_section",args:{id:f,action:j}}],l="setmarker"===j?a(i.SECTIONLI+".current"):null,q=b.call(k,!0);a.when.apply(a,q).done(function(a){"setmarker"===j?(e.addClass("current"),u(e,i.HIGHLIGHT,"i/marked","highlightoff","core","markedthistopic","core"),l.removeClass("current"),u(l,i.HIGHLIGHT,"i/marker","highlight","core","markthistopic","core")):(e.removeClass("current"),u(e,i.HIGHLIGHT,"i/marker","highlight","core","markthistopic","core")),o(e,g,400),p(h,400),e.trigger({type:"coursesectionedited",ajaxreturn:a,action:j,oldmarker:l})}).fail(function(b){o(e,g),p(e);var c=a.Event("coursesectioneditfailed",{exception:b,action:j});e.trigger(c),c.isDefaultPrevented()||d.exception(b)})};return g.use("moodle-course-coursebase",function(){M.course.coursebase.register_module({set_visibility_resource_ui:function(b){var c=a(b.element.getDOMNode()),d=j(c);if(d){var e=c.find("."+h.EDITINGMOVE).attr("data-sr"),f=a("<span>").attr("data-action","view").attr("data-sr",e);s(c,d,f)}}})}),{initCoursePage:function(b){a("body").on("click keypress",i.ACTIVITYLI+" "+i.ACTIVITYACTION,function(b){if("keypress"!==b.type||13===b.keyCode){var c=a(this),d=c.closest(i.ACTIVITYLI),e=c.attr("data-action"),f=j(d);switch(e){case"moveleft":case"moveright":case"delete":case"duplicate":case"hide":case"stealth":case"show":case"groupsseparate":case"groupsvisible":case"groupsnone":break;default:return}f&&(b.stopImmediatePropagation(),b.preventDefault(),"delete"===e?t(d,function(){s(d,f,c)}):s(d,f,c))}}),a("body").on("click keypress",i.SECTIONLI+" "+i.SECTIONACTIONMENU+" "+i.SHOWHIDE,function(c){if("keypress"!==c.type||13===c.keyCode){var d=a(this),e=d.closest(i.SECTIONLI),f=d.closest(i.SECTIONACTIONMENU),g=f.attr("data-sectionid");g&&(c.stopImmediatePropagation(),c.preventDefault(),v(b,e,g,d.attr("data-sr")))}}),a("body").on("click keypress",i.SECTIONLI+" "+i.SECTIONACTIONMENU+" "+i.HIGHLIGHT,function(c){if("keypress"!==c.type||13===c.keyCode){var d=a(this),e=d.closest(i.SECTIONLI),f=d.closest(i.SECTIONACTIONMENU),g=f.attr("data-sectionid");g&&(c.stopImmediatePropagation(),c.preventDefault(),w(b,e,g))}})}}});