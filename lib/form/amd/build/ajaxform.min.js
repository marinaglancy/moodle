define ("core_form/ajaxform",["exports","core/ajax","core/notification","core/templates","core/event","core/str","core/yui","core/fragment"],function(a,b,c,d,e,f,g,h){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.default=void 0;b=i(b);c=i(c);d=i(d);e=i(e);g=i(g);h=i(h);function i(a){return a&&a.__esModule?a:{default:a}}function j(a){return m(a)||l(a)||p(a)||k()}function k(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function l(a){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(a))return Array.from(a)}function m(a){if(Array.isArray(a))return q(a)}function n(a,b){return s(a)||r(a,b)||p(a,b)||o()}function o(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function p(a,b){if(!a)return;if("string"==typeof a)return q(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);if("Object"===c&&a.constructor)c=a.constructor.name;if("Map"===c||"Set"===c)return Array.from(c);if("Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c))return q(a,b)}function q(a,b){if(null==b||b>a.length)b=a.length;for(var c=0,d=Array(b);c<b;c++){d[c]=a[c]}return d}function r(a,b){if("undefined"==typeof Symbol||!(Symbol.iterator in Object(a)))return;var c=[],d=!0,e=!1,f=void 0;try{for(var g=a[Symbol.iterator](),h;!(d=(h=g.next()).done);d=!0){c.push(h.value);if(b&&c.length===b)break}}catch(a){e=!0;f=a}finally{try{if(!d&&null!=g["return"])g["return"]()}finally{if(e)throw f}}return c}function s(a){if(Array.isArray(a))return a}function t(a){"@babel/helpers - typeof";if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){t=function(a){return typeof a}}else{t=function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a}}return t(a)}function u(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function v(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var h=a.apply(b,c);function f(a){u(h,d,e,f,g,"next",a)}function g(a){u(h,d,e,f,g,"throw",a)}f(void 0)})}}function w(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}function x(a,b){for(var c=0,d;c<b.length;c++){d=b[c];d.enumerable=d.enumerable||!1;d.configurable=!0;if("value"in d)d.writable=!0;Object.defineProperty(a,d.key,d)}}function y(a,b,c){if(b)x(a.prototype,b);if(c)x(a,c);return a}var z=function(){function a(b,c){w(this,a);this.formClass=c;this.container=b;this.init()}y(a,[{key:"init",value:function(){var a=v(regeneratorRuntime.mark(function a(){var b,d,e;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:d="";if("object"===t(this.container)){b=this.container}else{b=document;d=this.container+" "}a.next=4;return(0,f.get_strings)([{key:"collapseall",component:"moodle"},{key:"expandall",component:"moodle"}]).catch(c.default.exception);case 4:e=function(a,b,c,d){a.addEventListener(b,function(a){if(a.target.matches(c)){d(a)}})};e(b,"click",d+"form input[type=submit][data-cancel]",this.cancelButtonPressed.bind(this));e(b,"click",d+"form input[type=submit][data-no-submit]",this.noSubmitButtonPressed.bind(this));e(b,"submit",d+"form",this.submitFormAjax.bind(this));case 8:case"end":return a.stop();}}},a,this)}));return function init(){return a.apply(this,arguments)}}()},{key:"findContainerElement",value:function findContainerElement(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:null;if("object"===t(this.container)){return this.container}else if(a){return a.closest(this.container)}else{return document.querySelector(this.container)}}},{key:"load",value:function load(a){var b=this,c=Object.keys(a||{}).map(function(b){return encodeURIComponent(b)+"="+encodeURIComponent(a[b])}).join("&");return this.getBody(c).then(function(a){var c=n(a,2),d=c[0],e=c[1];return b.updateForm(b.findContainerElement(),d,e)})}},{key:"getBody",value:function getBody(a){var c=this;return new Promise(function(d,e){b.default.call([{methodname:"core_form_modal",args:{formdata:a,form:c.formClass}}])[0].then(function(a){return d([a.html,h.default.processCollectedJavascript(a.javascript)])}).catch(function(a){return e(a)})})}},{key:"onSubmitSuccess",value:function onSubmitSuccess(a,b){b.innerHTML="";return a}},{key:"onValidationError",value:function onValidationError(){}},{key:"onCancel",value:function onCancel(a){a.innerHTML=""}},{key:"onSubmitError",value:function onSubmitError(a){c.default.exception(a)}},{key:"serializeForm",value:function serializeForm(a){var b=new FormData(a);return j(b.keys()).map(function(a){return encodeURIComponent(a)+"="+encodeURIComponent(b.get(a))}).join("&")}},{key:"noSubmitButtonPressed",value:function(){var a=v(regeneratorRuntime.mark(function a(b){var d=this,e,f,g;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:b.preventDefault();e=b.target;f=this.findContainerElement(e);a.next=5;return this.notifyFormSubmitAjax(f.querySelector("form"),!0);case 5:g=this.serializeForm(f.querySelector("form"))+"&"+encodeURIComponent(e.getAttribute("name"))+"="+encodeURIComponent(e.getAttribute("value"));this.disableButtons(f);this.getBody(g).then(function(a){var b=n(a,2),c=b[0],e=b[1];return d.updateForm(f,c,e)}).catch(c.default.exception);case 8:case"end":return a.stop();}}},a,this)}));return function noSubmitButtonPressed(){return a.apply(this,arguments)}}()},{key:"notifyFormSubmitAjax",value:function(){var a=v(regeneratorRuntime.mark(function a(b){var c,d,f=arguments;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:c=1<f.length&&f[1]!==void 0?f[1]:!1;d=new Promise(function(a){g.default.use("event","moodle-core-event","moodle-core-formchangechecker",function(){e.default.notifyFormSubmitAjax(b,c);a()})});a.next=4;return d;case 4:case"end":return a.stop();}}},a)}));return function notifyFormSubmitAjax(){return a.apply(this,arguments)}}()},{key:"cancelButtonPressed",value:function(){var a=v(regeneratorRuntime.mark(function a(b){var c,d;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:b.preventDefault();c=this.findContainerElement(b.target),d=c.querySelector("form");a.next=4;return this.notifyFormSubmitAjax(d,!0);case 4:M.core_formchangechecker.reset_form_dirty_state();this.onCancel(c);case 6:case"end":return a.stop();}}},a,this)}));return function cancelButtonPressed(){return a.apply(this,arguments)}}()},{key:"updateForm",value:function updateForm(a,b,c){d.default.replaceNodeContents(a,b,c)}},{key:"validateElements",value:function(){var a=v(regeneratorRuntime.mark(function a(b){var c;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.next=2;return this.notifyFormSubmitAjax(b.querySelector("form"));case 2:c=j(b.querySelectorAll("[aria-invalid=\"true\"], .error"));if(!c.length){a.next=6;break}c[0].focus();return a.abrupt("return",!1);case 6:return a.abrupt("return",!0);case 7:case"end":return a.stop();}}},a,this)}));return function validateElements(){return a.apply(this,arguments)}}()},{key:"disableButtons",value:function disableButtons(a){j(a.querySelectorAll("form input[type=\"submit\"]")).map(function(a){return a.setAttribute("disabled",!0)})}},{key:"enableButtons",value:function enableButtons(a){j(a.querySelectorAll("form input[type=\"submit\"]")).map(function(a){return a.removeAttribute("disabled")})}},{key:"submitFormAjax",value:function(){var a=v(regeneratorRuntime.mark(function a(c){var d,e;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:c.preventDefault();d=this.findContainerElement(c.target);a.next=4;return this.validateElements(d);case 4:if(a.sent){a.next=6;break}return a.abrupt("return");case 6:this.disableButtons(d);e=this.serializeForm(d.querySelector("form"));b.default.call([{methodname:"core_form_modal",args:{formdata:e,form:this.formClass}}])[0].then(function(a){if(!a.submitted){this.updateForm(d,a.html,h.default.processCollectedJavascript(a.javascript));this.enableButtons(d);this.onValidationError()}else{g.default.use("moodle-core-formchangechecker",function(){M.core_formchangechecker.reset_form_dirty_state()});var b=JSON.parse(a.data);this.enableButtons(d);this.onSubmitSuccess(b,d)}return null}.bind(this)).fail(this.onSubmitError.bind(this));case 9:case"end":return a.stop();}}},a,this)}));return function submitFormAjax(){return a.apply(this,arguments)}}()}]);return a}();a.default=z;return a.default});
//# sourceMappingURL=ajaxform.min.js.map
