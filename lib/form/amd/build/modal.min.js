define(["jquery","core/modal_factory","core/modal_events","core/fragment","core/ajax","core/notification","core/yui","core/event"],function(a,b,c,d,e,f,g,h){var i=function(a){this.config=a,this.config.modalConfig=this.config.modalConfig||{},this.config.modalConfig.type=this.config.modalConfig.type||b.types.SAVE_CANCEL,this.config.args=this.config.args||{},this.init()};return i.prototype.config={},i.prototype.modal=null,i.prototype.init=function(){b.create(this.config.modalConfig,this.config.triggerElement).then(function(b){return this.modal=b,this.modal.setBody(this.getBody(a.param(this.config.args))),this.modal.setLarge(),this.modal.getRoot().on(c.hidden,function(){h.notifyFormSubmitAjax(this.modal.getRoot().find("form")[0]),this.modal.destroy(),this.resetDirtyFormState()}.bind(this)),this.modal.getModal().addClass("modal-form-dialogue"),this.modal.getRoot().on("click","form input[type=submit][data-no-submit]",this.noSubmitButtonPressed.bind(this)),this.modal.getRoot().on("submit","form",this.submitFormAjax.bind(this)),"undefined"!=typeof this.config.saveButtonText&&"undefined"!=typeof this.modal.setSaveButtonText&&this.modal.setSaveButtonText(this.config.saveButtonText),this.onInit(),this.modal.show(),this.modal}.bind(this)).fail(f.exception)},i.prototype.onInit=function(){this.modal.getRoot().on(c.save,this.submitForm.bind(this))},i.prototype.getBody=function(b){var c=a.Deferred();return e.call([{methodname:"core_form_modal",args:{formdata:b,form:this.config.formClass}}])[0].then(function(a){return c.resolve(a.html,d.processCollectedJavascript(a.javascript)),null}).fail(function(a){c.reject(a)}),c},i.prototype.onSubmitSuccess=function(a){return a},i.prototype.onValidationError=function(){},i.prototype.onSubmitError=function(a){f.exception(a)},i.prototype.resetDirtyFormState=function(){g.use("moodle-core-formchangechecker",function(){M.core_formchangechecker.reset_form_dirty_state()})},i.prototype.noSubmitButtonPressed=function(b){b.preventDefault(),"undefined"!=typeof window.tinyMCE&&window.tinyMCE.triggerSave();var c=this.modal.getRoot().find("form").serialize(),d=a(b.currentTarget);c=c+"&"+encodeURIComponent(d.attr("name"))+"="+encodeURIComponent(d.attr("value")),this.modal.setBody(this.getBody(c))},i.prototype.validateElements=function(){var b=document.createEvent("HTMLEvents");b.initEvent("change",!0,!0),this.modal.getRoot().find(":input").each(function(a,c){c.dispatchEvent(b)});var c=a.merge(this.modal.getRoot().find('[aria-invalid="true"]'),this.modal.getRoot().find(".error"));return!c.length||(c.first().focus(),!1)},i.prototype.submitFormAjax=function(b){if(b.preventDefault(),"undefined"!=typeof window.tinyMCE&&window.tinyMCE.triggerSave(),this.validateElements()){var c=this.modal.getRoot().find("form").serialize();e.call([{methodname:"core_form_modal",args:{formdata:c,form:this.config.formClass}}])[0].then(function(b){if(b.submitted){var c=JSON.parse(b.data);this.modal.hide(),this.onSubmitSuccess(c)}else{var e=a.Deferred();e.resolve(b.html,d.processCollectedJavascript(b.javascript)),this.modal.setBody(e),this.onValidationError()}}.bind(this)).fail(this.onSubmitError.bind(this))}},i.prototype.submitForm=function(a){a.preventDefault(),this.modal.getRoot().find("form").submit()},i});