define(["jquery","core/modal_factory","core/modal_events","core/fragment","core/ajax","core/notification","core/yui"],function(a,b,c,d,e,f,g){var h=function(a){this.config=a,this.config.modalConfig=this.config.modalConfig||{},this.config.modalConfig.type=this.config.modalConfig.type||b.types.SAVE_CANCEL,this.config.args=this.config.args||{},this.init()};return h.prototype.config={},h.prototype.modal=null,h.prototype.init=function(){b.create(this.config.modalConfig,this.config.triggerElement).then(function(b){return this.modal=b,this.modal.setBody(this.getBody(a.param(this.config.args))),this.modal.setLarge(),this.modal.getRoot().on(c.hidden,function(){this.modal.destroy(),this.resetDirtyFormState()}.bind(this)),this.modal.getModal().addClass("modal-form-dialogue"),this.modal.getRoot().on("submit","form",this.submitFormAjax.bind(this)),"undefined"!=typeof this.config.saveButtonText&&"undefined"!=typeof this.modal.setSaveButtonText&&this.modal.setSaveButtonText(this.config.saveButtonText),this.onInit(),this.modal.show(),this.modal}.bind(this)).fail(f.exception)},h.prototype.onInit=function(){this.modal.getRoot().on(c.save,this.submitForm.bind(this))},h.prototype.getBody=function(b){var c=a.Deferred();return e.call([{methodname:"core_form_modal",args:{formdata:b,form:this.config.formClass}}])[0].then(function(a){return c.resolve(a.html,d.processCollectedJavascript(a.javascript)),null}).fail(function(a){c.reject(a)}),c},h.prototype.onSubmitSuccess=function(a){return a},h.prototype.onValidationError=function(){},h.prototype.onSubmitError=function(a){f.exception(a)},h.prototype.resetDirtyFormState=function(){g.use("moodle-core-formchangechecker",function(){M.core_formchangechecker.reset_form_dirty_state()})},h.prototype.submitFormAjax=function(b){b.preventDefault();var c=document.createEvent("HTMLEvents");c.initEvent("change",!0,!0),this.modal.getRoot().find(":input").each(function(a,b){b.dispatchEvent(c)});var f=a.merge(this.modal.getRoot().find('[aria-invalid="true"]'),this.modal.getRoot().find(".error"));if(f.length)return void f.first().focus();var g=this.modal.getRoot().find("form").serialize();e.call([{methodname:"core_form_modal",args:{formdata:g,form:this.config.formClass}}])[0].then(function(b){if(b.submitted){var c=JSON.parse(b.data);this.modal.hide(),this.onSubmitSuccess(c)}else{var e=a.Deferred();e.resolve(b.html,d.processCollectedJavascript(b.javascript)),this.modal.setBody(e),this.onValidationError()}}.bind(this)).fail(this.onSubmitError.bind(this))},h.prototype.submitForm=function(a){a.preventDefault(),this.modal.getRoot().find("form").submit()},h});