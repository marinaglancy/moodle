define ("core_form/modal",["exports","core/modal_factory","core/modal_events","core/ajax","core/notification","core/yui","core/event","core/str","core/fragment"],function(a,b,c,d,e,f,g,h,i){"use strict";Object.defineProperty(a,"__esModule",{value:!0});a.default=void 0;b=j(b);c=j(c);d=j(d);e=j(e);f=j(f);g=j(g);i=j(i);function j(a){return a&&a.__esModule?a:{default:a}}function k(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){c(a);return}if(h.done){b(i)}else{Promise.resolve(i).then(d,e)}}function l(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){var h=a.apply(b,c);function f(a){k(h,d,e,f,g,"next",a)}function g(a){k(h,d,e,f,g,"throw",a)}f(void 0)})}}function m(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);if(b)d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable});c.push.apply(c,d)}return c}function n(a){for(var b=1,c;b<arguments.length;b++){c=null!=arguments[b]?arguments[b]:{};if(b%2){m(Object(c),!0).forEach(function(b){o(a,b,c[b])})}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(a,Object.getOwnPropertyDescriptors(c))}else{m(Object(c)).forEach(function(b){Object.defineProperty(a,b,Object.getOwnPropertyDescriptor(c,b))})}}return a}function o(a,b,c){if(b in a){Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0})}else{a[b]=c}return a}function p(a,b){if(!(a instanceof b)){throw new TypeError("Cannot call a class as a function")}}function q(a,b){for(var c=0,d;c<b.length;c++){d=b[c];d.enumerable=d.enumerable||!1;d.configurable=!0;if("value"in d)d.writable=!0;Object.defineProperty(a,d.key,d)}}function r(a,b,c){if(b)q(a.prototype,b);if(c)q(a,c);return a}var s=function(){function a(c){p(this,a);this.modal=null;this.config=c;this.config.modalConfig=n({removeOnClose:!0,type:b.default.types.SAVE_CANCEL},this.config.modalConfig||{});this.config.args=this.config.args||{};this.init()}r(a,[{key:"init",value:function init(){M.util.js_pending("core_form_modal_form_init");(0,h.get_strings)([{key:"collapseall",component:"moodle"},{key:"expandall",component:"moodle"}]).then(function(){return b.default.create(this.config.modalConfig)}.bind(this)).then(function(a){var b=this;this.modal=a;var d=Object.keys(this.config.args).map(function(a){return encodeURIComponent(a)+"="+encodeURIComponent(b.config.args[a])}).join("&");this.modal.setBody(this.getBody(d));this.modal.setLarge();this.modal.getRoot().on(c.default.hidden,function(){b.resetDirtyFormState();b.notifyFormSubmitAjax(!0).then(function(){b.modal.destroy();if(b.config.returnFocus){b.config.returnFocus.focus()}return null})});this.modal.getModal().addClass("tool-wp-modal-form-dialogue");this.modal.getRoot().on("click","form input[type=submit][data-no-submit]",this.noSubmitButtonPressed.bind(this));this.modal.getRoot().on("submit","form",this.submitFormAjax.bind(this));if("undefined"!=typeof this.config.saveButtonText&&"undefined"!=typeof this.modal.setSaveButtonText){this.modal.setSaveButtonText(this.config.saveButtonText)}if("undefined"!=typeof this.config.saveButtonClasses){this.setSaveButtonClasses(this.config.saveButtonClasses)}if("SAVE_CANCEL_OTHER"===this.config.modalConfig.type){this.modal.registerCloseOnOther(this.registerCloseOnOther)}this.onInit();this.modal.show();M.util.js_complete("core_form_modal_form_init");return this.modal}.bind(this)).fail(e.default.exception)}},{key:"onInit",value:function onInit(){this.modal.getRoot().on(c.default.save,this.submitForm.bind(this))}},{key:"registerCloseOnOther",value:function registerCloseOnOther(a){return a}},{key:"getBody",value:function getBody(a){var b={formdata:a,form:this.config.formClass};M.util.js_pending("core_form_modal_form_body");return d.default.call([{methodname:"core_form_modal",args:b}])[0].then(function(a){M.util.js_complete("core_form_modal_form_body");return[a.html,i.default.processCollectedJavascript(a.javascript)]})}},{key:"onSubmitSuccess",value:function onSubmitSuccess(a){return a}},{key:"onValidationError",value:function onValidationError(){}},{key:"onSubmitError",value:function onSubmitError(a){e.default.exception(a)}},{key:"resetDirtyFormState",value:function resetDirtyFormState(){f.default.use("moodle-core-formchangechecker",function(){M.core_formchangechecker.reset_form_dirty_state()})}},{key:"notifyFormSubmitAjax",value:function notifyFormSubmitAjax(){var a=this,b=0<arguments.length&&arguments[0]!==void 0?arguments[0]:!1,c=new Promise(function(c){f.default.use("event","moodle-core-event","moodle-core-formchangechecker",function(){g.default.notifyFormSubmitAjax(a.modal.getRoot().find("form")[0],b);c()})});return c}},{key:"noSubmitButtonPressed",value:function(){var a=l(regeneratorRuntime.mark(function a(b){var c,d;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:b.preventDefault();c=b.currentTarget;a.next=4;return this.notifyFormSubmitAjax(!0);case 4:d=this.modal.getRoot().find("form").serialize();d=d+"&"+encodeURIComponent(c.getAttribute("name"))+"="+encodeURIComponent(c.getAttribute("value"));this.modal.setBody(this.getBody(d));case 7:case"end":return a.stop();}}},a,this)}));return function noSubmitButtonPressed(){return a.apply(this,arguments)}}()},{key:"validateElements",value:function(){var a=l(regeneratorRuntime.mark(function a(){var b;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:a.next=2;return this.notifyFormSubmitAjax();case 2:b=this.modal.getRoot().find("[aria-invalid=\"true\"], .error");if(!b.length){a.next=6;break}b.first().focus();return a.abrupt("return",!1);case 6:return a.abrupt("return",!0);case 7:case"end":return a.stop();}}},a,this)}));return function validateElements(){return a.apply(this,arguments)}}()},{key:"disableButtons",value:function disableButtons(){this.modal.getFooter().find("[data-action]").attr("disabled",!0)}},{key:"enableButtons",value:function enableButtons(){this.modal.getFooter().find("[data-action]").removeAttr("disabled")}},{key:"submitFormAjax",value:function(){var a=l(regeneratorRuntime.mark(function a(b){var c;return regeneratorRuntime.wrap(function(a){while(1){switch(a.prev=a.next){case 0:b.preventDefault();a.next=3;return this.validateElements();case 3:if(a.sent){a.next=5;break}return a.abrupt("return");case 5:this.disableButtons();c=this.modal.getRoot().find("form").serialize();d.default.call([{methodname:"core_form_modal",args:{formdata:c,form:this.config.formClass}}])[0].then(function(a){if(!a.submitted){var c=new Promise(function(b){return b(a.html,i.default.processCollectedJavascript(a.javascript))});this.modal.setBody(c);this.enableButtons();this.onValidationError()}else{var b=JSON.parse(a.data);this.modal.hide();this.onSubmitSuccess(b)}return null}.bind(this)).fail(this.onSubmitError.bind(this));case 8:case"end":return a.stop();}}},a,this)}));return function submitFormAjax(){return a.apply(this,arguments)}}()},{key:"submitForm",value:function submitForm(a){a.preventDefault();this.modal.getRoot().find("form").submit()}},{key:"setSaveButtonClasses",value:function setSaveButtonClasses(a){var b=this.modal.getFooter().find("[data-action='save']");if(!b){throw new Error("Unable to find the 'save' button")}b.removeClass().addClass(a)}}]);return a}();a.default=s;return a.default});
//# sourceMappingURL=modal.min.js.map
