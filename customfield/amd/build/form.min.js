define(["jquery","core/str","core/notification","core/ajax","core/templates","core/sortable_list","core_form/modal"],function(a,b,c,d,e,f,g){var h=function(f,g,h,i,j){b.get_strings([{key:"confirm"},{key:"confirmdelete"+g,component:"core_customfield"},{key:"yes"},{key:"no"}]).done(function(b){c.confirm(b[0],b[1],b[2],b[3],function(){var b="field"===g?"core_customfield_delete_field":"core_customfield_delete_category";d.call([{methodname:b,args:{id:f}},{methodname:"core_customfield_reload_template",args:{component:h,area:i,itemid:j}}])[1].then(function(a){return e.render("core_customfield/list",a)}).then(function(b,c){return e.replaceNodeContents(a('[data-region="list-page"]'),b,c),null}).fail(c.exception)})}).fail(c.exception)},i=function(b,f,g){var h,i=d.call([{methodname:"core_customfield_create_category",args:{component:b,area:f,itemid:g}},{methodname:"core_customfield_reload_template",args:{component:b,area:f,itemid:g}}]);i[0].then(function(a){return h=a,null}).fail(c.exception),i[1].then(function(a){return e.render("core_customfield/list",a)}).then(function(b,c){return e.replaceNodeContents(a('[data-region="list-page"]'),b,c),window.location.href="#category-"+h,null}).fail(c.exception)},j=function(a){var c=new g({formClass:"core_customfield\\field_config_form",args:{categoryid:a.data("categoryid"),type:a.data("type")},modalConfig:{title:b.get_string("addingnewcustomfield","core_customfield",a.data("typename"))},triggerElement:a});c.onSubmitSuccess=function(){window.location.reload()}},k=function(a){var c=new g({formClass:"core_customfield\\field_config_form",args:{id:a.data("id")},modalConfig:{title:b.get_string("editingfield","core_customfield",a.data("name"))},triggerElement:a});c.onSubmitSuccess=function(){window.location.reload()}};return{init:function(){var e=a("#customfield_catlist"),g=e.attr("data-component"),l=e.attr("data-area"),m=e.attr("data-itemid");a("[data-role=deletefield]").on("click",function(b){h(a(this).attr("data-id"),"field",g,l,m),b.preventDefault()}),a("[data-role=deletecategory]").on("click",function(b){h(a(this).attr("data-id"),"category",g,l,m),b.preventDefault()}),a("[data-role=addnewcategory]").on("click",function(){i(g,l,m)}),a("[data-role=addfield]").on("click",function(b){j(a(b.currentTarget)),b.preventDefault()}),a("[data-role=editfield]").on("click",function(b){k(a(b.currentTarget)),b.preventDefault()});var n=function(a){return a.closest("[data-category-id]").find("[data-inplaceeditable][data-itemtype=category][data-component=core_customfield]").attr("data-value")},o=new f("#customfield_catlist .categorieslist",{moveHandlerSelector:".movecategory [data-drag-type=move]"});o.getElementName=function(b){return a.Deferred().resolve(n(b))},a("[data-category-id]").on("sortablelist-drop",function(a,b){if(b.positionChanged){var e=d.call([{methodname:"core_customfield_move_category",args:{id:b.element.data("category-id"),beforeid:b.targetNextElement.data("category-id")}}]);e[0].fail(c.exception)}a.stopPropagation()});var p=new f("#customfield_catlist .fieldslist tbody",{moveHandlerSelector:".movefield [data-drag-type=move]"});p.getDestinationName=function(c,d){return d.length?d.attr("data-field-name")?b.get_string("afterfield","customfield",d.attr("data-field-name")):a.Deferred().resolve(""):b.get_string("totopofcategory","customfield",n(c))},a("[data-field-name]").on("sortablelist-drop",function(a,b){if(a.stopPropagation(),b.positionChanged){var e=d.call([{methodname:"core_customfield_move_field",args:{id:b.element.data("field-id"),beforeid:b.targetNextElement.data("field-id"),categoryid:Number(b.targetList.closest("[data-category-id]").attr("data-category-id"))}}]);e[0].fail(c.exception)}}).on("sortablelist-drag",function(d){d.stopPropagation(),b.get_string("therearenofields","core_customfield").then(function(b){return a("#customfield_catlist .categorieslist").children().each(function(){var c=a(this).find(a(".field")),d=a(this).find(a(".nofields"));c.length||d.length||a(this).find("tbody").append('<tr class="nofields"><td colspan="5">'+b+"</td></tr>"),c.length&&d.length&&d.remove()}),null}).fail(c.exception)}),a("[data-category-id], [data-field-name]").on("sortablelist-dragstart",function(b,c){setTimeout(function(){a(".sortable-list-is-dragged").width(c.element.width())},501)})}}});